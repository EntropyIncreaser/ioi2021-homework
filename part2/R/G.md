注意到仅仅是为了最小化切断水管数量的话，我们只切最靠上的就够了。因此切的水管数量就是根节点有几颗子树里有海盗。而为了最小化覆盖的叶子数，我们需要让水管覆盖这个子树的所有海盗的同时尽量靠下，那么就是整个集合的 LCA 的位置是最优的。我们考虑 DFS 序最小和最大二者的 LCA 其实就是整个集合的 LCA 了，用一个 $\texttt{std::set<int>}$ 维护即可查询这两个海盗。时间复杂度 $O(n + q\log n)$。
